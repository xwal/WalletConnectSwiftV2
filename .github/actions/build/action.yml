name: 'build'
description: 'Compiles and stores artifacts for further use'

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v3

    - name: Install xcbeautify
      shell: bash
      run: brew install xcbeautify
    
    - name: Setup Xcode Version
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 14.2
  
    - uses: actions/cache@v3
      with:
        path: |
          .build
          ../SourcePackagesCache
          DerivedDataCache
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Resolve Dependencies
      shell: bash
      run: make resolve_packages

    - name: Build for testing
      shell: bash
      run: make build_all

    - name: Upload build Products
      uses: actions/upload-artifact@v3
      with:
        name: Products
        path: |
          DerivedDataCache/Build/Products